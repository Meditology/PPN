# AD

* [https://habr.com/ru/company/pt/blog/423903/](https://habr.com/ru/company/pt/blog/423903/)
* [https://habr.com/ru/company/jetinfosystems/blog/449278/](https://habr.com/ru/company/jetinfosystems/blog/449278/)
* [https://habr.com/ru/company/bastion/blog/598769/](https://habr.com/ru/company/bastion/blog/598769/)
* [https://xakep.ru/2019/10/16/windows-ad-hack/](https://xakep.ru/2019/10/16/windows-ad-hack/)
* [https://hausec.com/2019/03/05/penetration-testing-active-directory-part-i/](https://hausec.com/2019/03/05/penetration-testing-active-directory-part-i/)
* [https://hausec.com/2019/03/12/penetration-testing-active-directory-part-ii/](https://hausec.com/2019/03/12/penetration-testing-active-directory-part-ii/)
* [https://kalitut.com/hacking-windows-active-directory-full/](https://kalitut.com/hacking-windows-active-directory-full/)
* [https://rmusser.net/docs/Active_Directory.html](https://rmusser.net/docs/Active_Directory.html)
* [https://zer1t0.gitlab.io/posts/attacking_ad/](https://zer1t0.gitlab.io/posts/attacking_ad/)
* [https://rootdse.org/posts/active-directory-basics-1/](https://rootdse.org/posts/active-directory-basics-1/)
* [https://rootdse.org/posts/active-directory-basics-2/](https://rootdse.org/posts/active-directory-basics-2/)
* [Атаки на домен / XSS.is](https://xss.is/threads/29895/)

{% embed url="https://youtu.be/5VW_eQD1-eA" %}

{% embed url="https://youtu.be/ReHn7c8qlIo" %}

![Pentesting AD Mindmap](https://raw.githubusercontent.com/Orange-Cyberdefense/arsenal/master/mindmap/pentest_ad_dark.png)




## Microsoft Wont-Fix-List

* [https://github.com/cfalta/MicrosoftWontFixList/blob/main/README.md](https://github.com/cfalta/MicrosoftWontFixList/blob/main/README.md)




## Tools



### BloodHound

- [https://github.com/BloodHoundAD/BloodHound](https://github.com/BloodHoundAD/BloodHound)
- [https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-1/](https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-1/)
- [https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-2/](https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-2/)
- [https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-3/](https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-3/)


#### Setup

```bash
curl -sSL https://api.github.com/repos/BloodHoundAD/BloodHound/releases/latest | jq -r '.assets[].browser_download_url' | grep 'BloodHound-linux-x64.zip' | wget -O 'BloodHound.zip' -i -
unzip BloodHound.zip && rm BloodHound.zip
mv BloodHound-linux-x64 BloodHound && cd BloodHound
sudo chown root:root chrome-sandbox
sudo chmod 4755 chrome-sandbox
chmod +x BloodHound
sudo mkdir /usr/share/neo4j/logs/

mkdir -p ~/.config/bloodhound
curl -sSL https://github.com/ShutdownRepo/Exegol-images/raw/main/sources/bloodhound/customqueries.json > /tmp/customqueries1.json
curl -sSL https://github.com/CompassSecurity/BloodHoundQueries/raw/master/customqueries.json > /tmp/customqueries2.json
curl -sSL https://github.com/ZephrFish/Bloodhound-CustomQueries/raw/main/customqueries.json > /tmp/customqueries3.json
curl -sSL https://github.com/ly4k/Certipy/raw/main/customqueries.json > /tmp/customqueries4.json

python3 - << 'EOT'
import json
from pathlib import Path

merged, dups = {'queries': []}, set()
for jf in sorted((Path('/tmp')).glob('customqueries*.json')):
	with open(jf, 'r') as f:
		for query in json.load(f)['queries']:
			if 'queryList' in query.keys():
				qt = tuple(q['query'] for q in query['queryList'])
				if qt not in dups:
					merged['queries'].append(query)
					dups.add(qt)

with open(Path.home() / '.config' / 'bloodhound' / 'customqueries.json', 'w') as f:
	json.dump(merged, f, indent=4)

EOT

rm /tmp/customqueries*.json
curl -sSL "https://github.com/ShutdownRepo/Exegol-images/raw/main/sources/bloodhound/config.json" > ~/.config/bloodhound/config.json
sed -i 's/"password": "exegol4thewin"/"password": "WeaponizeK4li!"/g' ~/.config/bloodhound/config.json
```


#### Collectors

##### SharpHound.exe

- [https://github.com/BloodHoundAD/SharpHound3](https://github.com/BloodHoundAD/SharpHound3)
- [https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.exe](https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.exe)
- [https://bloodhound.readthedocs.io/en/latest/data-collection/sharphound-all-flags.html](https://bloodhound.readthedocs.io/en/latest/data-collection/sharphound-all-flags.html)

![SharpHound cheatsheet (by @SadProcessor)](https://bloodhound.readthedocs.io/en/latest/_images/SharpHoundCheatSheet.png)

```
PS > .\SharpHound.exe [-d megacorp.local] [--LdapUsername snovvcrash] [--LdapPassword 'Passw0rd!'] -c All,GPOLocalGroup [--Stealth] --CollectAllProperties --OutputDirectory C:\Windows\Temp --MemCache --ZipFileName backup_full.zip [--RandomFilenames] [--Throttle 100] [--Jitter 20]
PS > .\SharpHound.exe -c SessionLoop --Loop --LoopInterval 00:01:00 --Loopduration 03:09:41
```

##### SharpHound.ps1

- [https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.ps1](https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.ps1)

```
PS > Invoke-Bloodhound [-Domain megacorp.local] [-LdapUsername snovvcrash] [-LdapPassword 'Passw0rd!'] -CollectionMethod All,GPOLocalGroup [-Stealth] -CollectAllProperties -OutputDirectory C:\Windows\Temp -NoSaveCache -RandomizeFilenames -ZipFileName backup_full.zip [-Throttle 100] [-Jitter 20]
PS > Invoke-Bloodhound -CollectionMethod SessionLoop -Loop -LoopInterval 00:01:00 -Loopduration 03:09:41
```

##### BloodHound.py

* [https://github.com/fox-it/BloodHound.py](https://github.com/fox-it/BloodHound.py)

```
$ cd ~/ws/enum/bloodhound/bloodhound.py/
$ bloodhound-python -c All,LoggedOn -u snovvcrash -p 'Passw0rd!' -d megacorp.local -ns 192.168.1.11
$ proxychains4 -q bloodhound-python -c All,LoggedOn -u snovvcrash --hashes aad3b435b51404eeaad3b435b51404ee:fc525c9683e8fe067095ba2ddc971889 -d megacorp.local -ns 192.168.1.11 -dc DC01.megacorp.local -gc DC01.megacorp.local --dns-tcp
```

Import with [bloodhound-import](https://github.com/fox-it/bloodhound-import):

```
$ bloodhound-import -du neo4j -dp 'Passw0rd!' 20190115133114*.json
```

##### ADExplorerSnapshot.py

- [https://github.com/c3c/ADExplorerSnapshot.py](https://github.com/c3c/ADExplorerSnapshot.py)
- [https://docs.microsoft.com/en-us/sysinternals/downloads/adexplorer](https://docs.microsoft.com/en-us/sysinternals/downloads/adexplorer)


#### Cypher (Neo4j)

* [https://hausec.com/2019/09/09/bloodhound-cypher-cheatsheet/](https://hausec.com/2019/09/09/bloodhound-cypher-cheatsheet/)
* [https://github.com/ShutdownRepo/Exegol/blob/master/sources/bloodhound/customqueries.json](https://github.com/ShutdownRepo/Exegol/blob/master/sources/bloodhound/customqueries.json)
* [https://github.com/CompassSecurity/BloodHoundQueries/blob/master/customqueries.json](https://github.com/CompassSecurity/BloodHoundQueries/blob/master/customqueries.json)
* [https://github.com/ZephrFish/Bloodhound-CustomQueries/blob/main/customqueries.json](https://github.com/ZephrFish/Bloodhound-CustomQueries/blob/main/customqueries.json)
* [https://github.com/ly4k/Certipy/blob/main/customqueries.json](https://github.com/ly4k/Certipy/blob/main/customqueries.json)

Show percentage of collected user sessions:

{% embed url="https://youtu.be/q86VgM2Tafc?t=353" %}

```
# http://localhost:7474/browser/
MATCH (u1:User)
WITH COUNT(u1) AS totalUsers
MATCH (c:Computer)-[r:HasSession]->(u2:User)
WITH totalUsers, COUNT(DISTINCT(u2)) AS usersWithSessions
RETURN totalUsers, usersWithSessions, 100 * usersWithSessions / totalUsers AS percetange
```

Show path to any computer from kerberoastable users:

```
MATCH (u:User {hasspn:true}), (c:Computer), p=shortestPath((u)-[*1..]->(c)) RETURN p
```


#### Manual JSON Parsing

- [https://blog.bitsadmin.com/blog/dealing-with-large-bloodhound-datasets](https://blog.bitsadmin.com/blog/dealing-with-large-bloodhound-datasets)
- [https://github.com/bitsadmin/chophound](https://github.com/bitsadmin/chophound)

{% embed url="https://youtu.be/o3W4H0UfDmQ" %}

There're 2 global dicts in JSON files: `data` and `meta`. We care about `data`:

```json
$ cat 20220604031239_users.json | jq '. | keys'
[
  "data",
  "meta"
]
```

List all active user accounts:

```
cat 20220604031239_users.json | jq '.data[].Properties | select(.enabled == true) | .name' -r
```

List non-empty user accounts' descriptions:

```
cat 20220604031239_users.json | jq '.data[].Properties | select(.enabled == true and .description != null) | .name + " :: " + .description' -r
```

List user accounts whose passwords were set after their last logon (an effective list for password spraying assuming that the passwords were set by IT Desk and may be guessable):

```
cat 20220604031239_users.json | jq '.data[].Properties | select(.enabled == true and .pwdlastset > .lastlogontimestamp) | .name + " :: " + (.lastlogontimestamp | tostring)' -r
```

List user accounts with `DoesNotRequirePreAuth` set (aka [asreproastable](/pentest/infrastructure/ad/roasting.md#asreproasting)):

```
cat 20220604031239_users.json | jq '.data[].Properties | select(.enabled == true and .dontreqpreauth == true) | .name' -r
```

List user accounts with SPN(s) set (aka [kerberoastable](/pentest/infrastructure/ad/roasting.md#kerberoasting))

```
cat 20220604031239_users.json | jq '.data[].Properties | select(.enabled == true and .serviceprincipalnames != []) | .name + " :: " + (.serviceprincipalnames | join(","))' -r
```

List computer accounts' operating system names:

```
cat 20220604031239_computers.json | jq '.data[].Properties | .name + " :: " + .operatingsystem' -r
```

Recursively list all members of a group (mimics RSAT `Get-ADGroupMember`, [script](https://github.com/penetrarnya-tm/WeaponizeKali.sh/blob/main/misc/get_ad_group_member.py)):

```
$ ls
20220604043009_computers.json  20220604043009_groups.json  20220604043009_users.json
$ python3 get_ad_group_member.py 'DOMAIN ADMINS@MEGACORP.LOCAL'
```

Recursively list all groups which the user is a member of (mimics RSAT `Get-ADUser | select memberof`, [script](https://github.com/penetrarnya-tm/WeaponizeKali.sh/blob/main/misc/get_ad_user_memberof.py)):

```
$ ls
20220604043009_groups.json  20220604043009_users.json
$ python3 get_ad_user_memberof.py 'SNOVVCRASH@MEGACORP.LOCAL'
```

Generate a `.csv` file containing AD trusts mapping to be used in [TrustVisualizer](https://github.com/snovvcrash/TrustVisualizer) (mimics PowerView `Get-DomainTrustMapping`, [script](https://github.com/penetrarnya-tm/WeaponizeKali.sh/blob/main/misc/get_domain_trust_mapping.py)):

```
$ ls
20220604043009_domains.json
$ python3 get_domain_trust_mapping.py
```



### PowerView / SharpView

* [https://www.harmj0y.net/blog/powershell/make-powerview-great-again/](https://www.harmj0y.net/blog/powershell/make-powerview-great-again/)
* [https://github.com/HarmJ0y/CheatSheets/blob/master/PowerView.pdf](https://github.com/HarmJ0y/CheatSheets/blob/master/PowerView.pdf)
* [https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993](https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993)
* [PowerView2.ps1](https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerView/powerview.ps1)
* [PowerView3.ps1](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1)
* [PowerView4.ps1](https://github.com/ZeroDayLab/PowerSploit/blob/master/Recon/PowerView.ps1) [(ZeroDayLab)](https://exploit.ph/powerview.html)
* [SharpView.exe](https://github.com/tevora-threat/SharpView/blob/master/Compiled/SharpView.exe)


#### Example Queries

##### Users

Convert SID to name and vice versa:

```
PV3 > ConvertTo-SID <NAME>
PV3 > Convert-NameToSid <NAME>
PV3 > ConvertFrom-SID <SID>
PV3 > Convert-SidToName <SID>
```

Extract all domain user accounts into a `.csv` file:

```
PV3 > Get-DomainUser -Domain megacorp.local | select name,samAccountName,description,memberOf,whenCreated,pwdLastSet,lastLogonTimestamp,accountExpires,adminCount,userPrincipalName,servicePrincipalName,mail,userAccountControl | Export-Csv .\all-users.csv -NoTypeInformation
```

List domain user accounts that do not require Kerberos **pre-authentication** (see [ASREPRoasting](/pentest/infrastructure/ad/roasting.md#asreproasting)):

```
PS > .\SharpView.exe Get-DomainUser -KerberosPreauthNotRequired -Properties samAccountName,userAccountControl,memberOf
```

List domain user accounts with **Service Principal Names** (SPNs) set (see [Kerberoasting](/pentest/infrastructure/ad/roasting.md#kerberoasting)):

```
PS > .\SharpView.exe Get-DomainUser -SPN -Properties samAccountName,memberOf,servicePrincipalName
```

List domain user accounts with Kerberos **unconstrained delegation** enabled:

```
PS > .\SharpView.exe Get-DomainUser -LDAPFilter "(userAccountControl:1.2.840.113556.1.4.803:=524288)"
```

List domain user accounts with Kerberos **constrained delegation** enabled:

```
PS > .\SharpView.exe Get-DomainUser -TrustedToAuth -Properties samAccountName,userAccountControl,memberOf
```

Search for domain user accounts which may have sensitive stored in the `description` field:

```
PV3 > Get-DomainUser -Properties samaccountname,description | Where {$_.description -ne $null}
```

Search for domain user by email:

```
PV3 > Get-DomainUser -LDAPFilter '(mail=snovvcrash@megacorp.com)' -Properties samaccountname
```

Find users with DCSync right:

```
PV3 > $dcsync = Get-DomainObjectACL "DC=megacorp,DC=local" -ResolveGUIDs | ? {$_.ActiveDirectoryRights -match "GenericAll" -or $_.ObjectAceType -match "Replication-Get"} | select -ExpandProperty SecurityIdentifier | select -ExpandProperty value
PV3 > Convert-SidToName $dcsync
```

##### Groups

Enumerate domain computers where specific users (Identity) are members of a specific local group (LocalGroup):

```
PV3 > Get-DomainGPOUserLocalGroupMapping -Identity snovvcrash -LocalGroup Administrators
```

##### Computers

Extract all domain computer accounts into a `.csv` file:

```
PV3 > Get-DomainComputer -Properties dnsHostName,operatingSystem,lastLogonTimestamp,userAccountControl | Export-Csv .\all-computers.csv -NoTypeInformation
```

List domain computer accounts that allow Kerberos **unconstrained delegation**:

```
PS > .\SharpView.exe Get-DomainComputer -Unconstrained -Properties dnsHostName,userAccountControl
```

Resolve all domain computer IPs by their names:

```
PV3 > Get-DomainComputer -Properties name | Resolve-IPAddress
```

List domain computers that are part of a OU:

```
PV3 > Get-DomainComputer | ? { $_.DistinguishedName -match "OU=<OU_NAME>" } | select dnsHostName
```

##### Shares

List shares for `WS01` computer:

```
PS > .\SharpView.exe Get-NetShare -ComputerName WS01
```

##### GPOs

List all domain users with a 4-digit RID (eliminates default objects like 516, 519, etc.) who can edit GPOs:

```
PV3 > Get-DomainGPO | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ActiveDirectoryRights -match "WriteProperty|WriteDacl|WriteOwner" -and $_.SecurityIdentifier -match "<SID>-[\d]{4,10}" } | select objectDN, activeDirectoryRights, securityIdentifier | fl
```

Resolve GPO ObjectDN:

```
PV3 > Get-DomainGPO -Name "<DN>" -Properties DisplayName
```



### Impacket

* [https://github.com/SecureAuthCorp/impacket](https://github.com/SecureAuthCorp/impacket)
* [https://github.com/ropnop/impacket_static_binaries](https://github.com/ropnop/impacket_static_binaries)
* [https://github.com/maaaaz/impacket-examples-windows](https://github.com/maaaaz/impacket-examples-windows)

Install:

```
$ git clone https://github.com/SecureAuthCorp/impacket ~/tools/impacket && cd ~/tools/impacket
$ pip3 install .
Or
$ pipx install -f "git+https://github.com/SecureAuthCorp/impacket.git"
```



### CrackMapExec

Install bleeding-edge:

```
$ git clone --recursive https://github.com/byt3bl33d3r/CrackMapExec ~/tools/CrackMapExec && cd ~/tools/CrackMapExec
$ poetry install
$ poetry run crackmapexec -h
Or
$ pipx install -f "git+https://github.com/byt3bl33d3r/CrackMapExec.git"
$ cme -h
```

Use:

```
$ cme smb 127.0.0.1
$ cme smb 127.0.0.1 -u anonymous -p '' 2>/dev/null
$ cme smb 127.0.0.1 -u anonymous -p '' --shares
$ cme smb 127.0.0.1 -u '' -p '' -d WORKGROUP --shares
$ cme smb 127.0.0.1 -u nullinux_users.txt -p passwords.txt --shares [--no-bruteforce] [--continue-on-success]
$ cme smb 127.0.0.1 -u snovvcrash -p 'Passw0rd!' --spider-folder 'E\$' --pattern s3cret
$ cme smb 127.0.0.1 -u j.doe -p 'Passw0rd!' -d 'CORP' --spider Users --pattern '.'
$ cme smb 127.0.0.1 -u Administrator -H fc525c9683e8fe067095ba2ddc971889 --local-auth --sam
$ cme smb 127.0.0.1 -u snovvcrash -p '' -M spider_plus
$ cme smb 127.0.0.1 -u snovvcrash -p '' -M mimikatz
$ cme smb 127.0.0.1 -u snovvcrash -p '' -M lsassy
$ cme smb 127.0.0.1 -u snovvcrash -p '' -x 'powershell gci \users\administrator -recurse -file -ea SilentlyContinue | select fullname'
```

{% code title="~/.cme/cme.conf" %}
```
[CME]
workspace=default
last_used_db=
pwn3d_label=Admin!

[BloodHound]
bh_enabled = True
bh_uri = 127.0.0.1
bh_port = 7687
bh_user = neo4j
bh_pass = Passw0rd!
```
{% endcode %}



### rpcclient

```
$ rpcclient -U '' -N 127.0.0.1
$ rpcclient -U 'snovvcrash%Passw0rd!' 127.0.0.1

rpcclient $> enumdomusers
rpcclient $> enumdomgroups
```



### enum4linux / enum4linux-ng

- [https://github.com/CiscoCXSecurity/enum4linux](https://github.com/CiscoCXSecurity/enum4linux)
- [https://github.com/cddmp/enum4linux-ng](https://github.com/cddmp/enum4linux-ng)

```
$ enum4linux -v -a 127.0.0.1 | tee enum4linux.out
```



### nullinux

* [https://github.com/m8r0wn/nullinux](https://github.com/m8r0wn/nullinux)

```
$ git clone https://github.com/m8r0wn/nullinux ~/tools/nullinux && cd ~/tools/nullinux && sudo bash setup.sh && ln -s ~/tools/nullinux/nullinux.py /usr/local/bin/nullinux.py && cd -
$ nullinux.py 127.0.0.1
```




## Mitigations

Common vulnerabilities & misconfigurations and recommendations:

* [https://www.infosecmatter.com/top-16-active-directory-vulnerabilities/#2-admincount-attribute-set-on-common-users](https://www.infosecmatter.com/top-16-active-directory-vulnerabilities/#2-admincount-attribute-set-on-common-users)
* [https://threadreaderapp.com/thread/1369309701050142720.html](https://threadreaderapp.com/thread/1369309701050142720.html)
* [https://s3cur3th1ssh1t.github.io/The-most-common-on-premise-vulnerabilities-and-misconfigurations/](https://s3cur3th1ssh1t.github.io/The-most-common-on-premise-vulnerabilities-and-misconfigurations/)
* [https://github.com/evilmog/ntlmv1-multi/blob/master/resources/checklist.txt](https://github.com/evilmog/ntlmv1-multi/blob/master/resources/checklist.txt)

SMB lateral-movement hardening:

* [https://posts.specterops.io/offensive-lateral-movement-1744ae62b14f](https://posts.specterops.io/offensive-lateral-movement-1744ae62b14f)
* [https://medium.com/palantir/restricting-smb-based-lateral-movement-in-a-windows-environment-ed033b888721](https://medium.com/palantir/restricting-smb-based-lateral-movement-in-a-windows-environment-ed033b888721)

{% file src="/.gitbook/assets/SMB Enumeration-Exploitation-Hardening (Anil BAS).pdf" %}

Antispam protection for Exchange:

{% file src="/.gitbook/assets/Antispam Forefront Protection 2010 (Exchange Server).pdf" %}

Detect stale, unused or fake computer accounts based on password age (replace `-90` with your domain's maximum computer account password age):

```
$date = [DateTime]::Today.AddDays(-90); Get-ADComputer -Filter '(Enabled -eq $true) -and (PasswordLastSet -le $date)' | select Name
```

Administrative Tier Model & Microsoft RaMP (Zero Trust **Ra**pid **M**odernization **P**lan):

* [https://security-tzu.com/2020/03/23/mitigate-credential-theft-with-administrative-tier-model/](https://security-tzu.com/2020/03/23/mitigate-credential-theft-with-administrative-tier-model/)
* [https://www.secframe.com/ramp/](https://www.secframe.com/ramp/)
* [https://posts.specterops.io/establish-security-boundaries-in-your-on-prem-ad-and-azure-environment-dcb44498cfc2](https://posts.specterops.io/establish-security-boundaries-in-your-on-prem-ad-and-azure-environment-dcb44498cfc2)

Post compromise AD actions (checklist):

- [https://www.pwndefend.com/2021/09/15/post-compromise-active-directory-checklist/](https://www.pwndefend.com/2021/09/15/post-compromise-active-directory-checklist/)
